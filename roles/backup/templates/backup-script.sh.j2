#!/bin/bash

# Restic backup script for {{ inventory_hostname }}
# Generated by Ansible - DO NOT EDIT MANUALLY

# Configuration
export RESTIC_REPOSITORY="{{ restic_repo }}"

# Wait for network to be fully ready
sleep 10

# Check if NFS is mounted
if ! mountpoint -q {{ nfs_mount_point }}; then
    echo "NFS not mounted, attempting mount..."
    mount {{ nfs_mount_point }}
    sleep 5
fi

# Check if mount succeeded
if ! mountpoint -q {{ nfs_mount_point }}; then
    echo "ERROR: Failed to mount NFS, aborting backup"
    exit 1
fi

# Backup paths
BACKUP_PATHS=(
{% for path in backup_paths %}
    "{{ path }}"
{% endfor %}
)

# Run backup
echo "========================================="
echo "Starting backup for {{ inventory_hostname }} at $(date)"
echo "========================================="

eval restic --insecure-no-password backup ${BACKUP_PATHS[@]} $EXCLUDE_ARGS \
    --tag {{ backup_tag }} \
    --tag automated \
    --verbose

BACKUP_EXIT_CODE=$?

if [ $BACKUP_EXIT_CODE -eq 0 ]; then
    echo "Backup successful, running retention policy..."
    
    # Retention policy
    restic --insecure-no-password forget \
        --keep-daily {{ retention_daily }} \
        --keep-weekly {{ retention_weekly }} \
        --keep-monthly {{ retention_monthly }} \
        --prune
    
    echo "========================================="
    echo "Backup completed successfully at $(date)"
    echo "========================================="
else
    echo "========================================="
    echo "ERROR: Backup failed with exit code $BACKUP_EXIT_CODE at $(date)"
    echo "========================================="
    exit $BACKUP_EXIT_CODE
fi